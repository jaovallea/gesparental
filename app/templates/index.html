<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GesParental</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script>
        function validarFormulario(form) {
            const radios = form.querySelectorAll('input[name="tipo"]');
            const seleccionado = Array.from(radios).some(r => r.checked);
            const comentario = form.querySelector('input[name="comentario"]').value.trim();
            if (!seleccionado) {
                alert("Por favor selecciona Falta o M√©rito antes de continuar.");
                return false;
            }
            if (!comentario) {
                alert("El comentario no puede estar vac√≠o.");
                return false;
            }
            return true;
        }
    </script>
</head>

<body class="bg-gray-100 font-sans">
    <div class="text-center py-4 bg-white shadow">
        <h1 class="text-2xl font-bold text-gray-800">
            üåü <span class="text-blue-700">GesParental</span>
        </h1>
    </div>

    <div class="grid md:grid-cols-2 gap-4 p-4">
        {% for n in nombres %}
        <div class="p-4 rounded-lg shadow bg-{{ 'purple' if loop.index == 1 else 'pink' }}-100">
            <h2 class="text-lg font-bold">{{ n }}</h2>
            <p class="text-sm">{{ estado[n] }}</p>
            <p class="text-xs italic text-green-700">{{ estado_detalle[n] }}</p>

            <div class="flex items-center justify-between">
                <!-- Cuadro informativo -->
                <div class="bg-white rounded p-2 text-sm shadow-md w-1/2">
                    <p>üìä <strong>Faltas:</strong> {{ faltas[n] }}</p>
                    <p>üèÖ <strong>M√©ritos:</strong> {{ resumen[n]['meritos'] }}</p>
                    <p>‚öñÔ∏è <strong>Total actual:</strong> {{ totales[n] }}</p>
                </div>

                <!-- Gr√°fico -->
                <div class="w-48 h-48">
                    <canvas id="chart_{{ n }}"></canvas>
                </div>
            </div>

            <div class="flex justify-center mt-2 text-sm text-gray-600">
                <div class="mr-4"><span class="text-red-400">‚¨õ</span> Faltas</div>
                <div><span class="text-green-400">‚¨õ</span> Restante</div>
            </div>

            <!-- Formulario -->
            <form action="/agregar" method="post" class="flex flex-col sm:flex-row gap-2 mt-4 items-center"
                  onsubmit="return validarFormulario(this)">
                <input type="hidden" name="nombre" value="{{ n }}">

                <div class="flex gap-3">
                    <label class="flex items-center gap-1">
                        <input type="radio" name="tipo" value="Falta" class="accent-red-500">
                        <span class="text-sm text-red-600">Falta</span>
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="radio" name="tipo" value="M√©rito" class="accent-green-500">
                        <span class="text-sm text-green-600">M√©rito</span>
                    </label>
                </div>

                <input type="text" name="comentario" placeholder="Comentario..."
                       class="border p-2 rounded flex-1 text-sm w-full sm:w-auto">

                <button type="submit" class="bg-blue-600 text-white text-sm px-3 py-2 rounded" title="Agregar registro">
                    ‚ûï
                </button>
            </form>

            <!-- Historial -->
            <div class="mt-4 text-sm max-h-40 overflow-y-auto">
                {% for r in registros[n] %}
                <div class="p-2 rounded my-1 flex justify-between items-center
                            {% if r.tipo == 'Falta' %} bg-red-50
                            {% elif r.tipo == 'M√©rito' %} bg-green-50
                            {% endif %}">
                    <span>
                        {{ r.fecha.strftime('%d/%m %H:%M') }} - <strong>{{ r.tipo }}</strong> - {{ r.comentario }}
                    </span>
                    <form action="/borrar_registro" method="post"
                          onsubmit="return confirm('¬øSeguro que deseas eliminar este registro?');">
                        <input type="hidden" name="id" value="{{ r.id }}">
                        <button type="submit" class="text-gray-400 hover:text-red-500" title="Eliminar registro">üóëÔ∏è</button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="p-4">
        <h3 class="font-bold mb-2">Resumen semanal</h3>
        <table class="min-w-full bg-white border">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-4 py-2 border">Nombre</th>
                    <th class="px-4 py-2 border">Faltas (√∫ltimos 7 d√≠as)</th>
                    <th class="px-4 py-2 border">M√©ritos (√∫ltimos 7 d√≠as)</th>
                </tr>
            </thead>
            <tbody>
                {% for n, data in resumen.items() %}
                <tr class="text-center {% if loop.index is even %}bg-gray-50{% endif %}">
                    <td class="border px-4 py-2">{{ n }}</td>
                    <td class="border px-4 py-2">{{ data.faltas }}</td>
                    <td class="border px-4 py-2">{{ data.meritos }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const graficos = {{ graficos|tojson }};
        for (const [nombre, data] of Object.entries(graficos)) {
            const ctx = document.getElementById(`chart_${nombre}`).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Faltas', 'Restante'],
                    datasets: [{
                        data: data,
                        backgroundColor: ['#f87171', '#86efac'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
